# Stage 1: Build the k3s binary
FROM alpine:3.20 as k3s-builder
WORKDIR /usr/local/bin
RUN apk add --no-cache curl openssl
RUN curl -sfL https://github.com/k3s-io/k3s/releases/download/v1.33.3%2Bk3s1/k3s -o k3s && \
    chmod +x k3s

# Stage 2: Build the Rancher server binary
FROM golang:1.24.6-alpine AS rancher-builder
WORKDIR /src
COPY rancher /usr/local/bin/rancher-server

# Stage 3: Final image with both binaries and startup script
FROM ubuntu:24.04

# Install necessary packages for certificates and other tools
RUN apt-get update && apt-get install -y iproute2 ca-certificates openssl curl && \
    rm -rf /var/lib/apt/lists/*

# Copy your custom CA certificate into the image
#COPY ./rancher.crt /usr/local/share/ca-certificates/rancher.crt

# Update the certificate store
#RUN update-ca-certificates

RUN curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# Copy both binaries from their respective build stages
COPY --from=k3s-builder /usr/local/bin/k3s /usr/local/bin/k3s
COPY --from=rancher-builder /usr/local/bin/rancher-server /usr/local/bin/rancher-server

# Create a simple startup script to run both
COPY start.sh /usr/local/bin/k3s-start.sh
RUN chmod +x /usr/local/bin/k3s-start.sh

# Expose ports
EXPOSE 80 443 6443

# Set the entrypoint
ENTRYPOINT ["/usr/local/bin/k3s-start.sh"]
